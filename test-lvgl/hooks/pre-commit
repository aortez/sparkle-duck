#!/bin/bash
#
# Pre-commit hook: Format and test staged C++ files.
#
# Installation: ln -sf ../../test-lvgl/hooks/pre-commit .git/hooks/pre-commit
#

# Get the root of the git repository.
REPO_ROOT=$(git rev-parse --show-toplevel)

# Get list of staged .cpp and .h files in test-lvgl.
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^test-lvgl/.*\.(cpp|h)$')

if [ -z "$STAGED_FILES" ]; then
    # No C++ files staged in test-lvgl, allow commit.
    exit 0
fi

echo "Running clang-format on staged files (matching CI behavior)..."

# Run make format in test-lvgl directory (same as CI).
cd "$REPO_ROOT/test-lvgl" || exit 1
make format

# Re-add all formatted files that were originally staged.
cd "$REPO_ROOT" || exit 1
for FILE in $STAGED_FILES; do
    git add "$FILE"
done

echo "Formatting complete. Files have been formatted and re-staged."

# Run tests unless explicitly skipped.
if [ "$SKIP_TESTS" != "1" ]; then
    echo "Running tests..."
    cd "$REPO_ROOT/test-lvgl" || exit 1

    # Run unit tests quietly, only show summary.
    TEST_OUTPUT=$(make test 2>&1)
    if echo "$TEST_OUTPUT" | tail -10 | grep -q "\[  FAILED  \]"; then
        echo ""
        echo "❌ Unit tests failed! Commit blocked."
        echo "To see details: make test"
        echo "To skip tests: SKIP_TESTS=1 git commit"
        exit 1
    fi

    echo "✅ Unit tests passed."

    # Run CLI integration test (quick smoke test of server + UI).
    echo "Running integration test..."
    if ! ./build-debug/bin/cli integration_test >/dev/null 2>&1; then
        echo ""
        echo "❌ Integration test failed! Commit blocked."
        echo "To see details: ./build-debug/bin/cli integration_test"
        echo "To skip tests: SKIP_TESTS=1 git commit"
        exit 1
    fi

    echo "✅ Integration test passed."

    # Note: Cache correctness is verified by CacheCorrectnessTest in unit tests above.
    # No need for separate CLI benchmark test in pre-commit hook.
fi

exit 0
